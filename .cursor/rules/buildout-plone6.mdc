---
globs: *.cfg,*.txt,*.py
description: Reglas para configuraciÃ³n de buildout en Plone 6
---

# ðŸ”§ Buildout Plone 6 - ConfiguraciÃ³n

## ðŸ“¦ Estructura de Buildout

```
organs6.buildout/
â”œâ”€â”€ buildout.cfg          # ConfiguraciÃ³n principal
â”œâ”€â”€ versions.cfg          # Versiones fijas
â”œâ”€â”€ sources.cfg           # Repositorios de desarrollo
â”œâ”€â”€ projects.cfg          # ConfiguraciÃ³n de proyectos
â”œâ”€â”€ customizeme.cfg       # PersonalizaciÃ³n local
â”œâ”€â”€ requirements.txt      # Dependencias Python
â”œâ”€â”€ organs.cfg            # ConfiguraciÃ³n completa para desarrollo
â”œâ”€â”€ zope-only.cfg         # Solo instancias Zope (producciÃ³n)
â”œâ”€â”€ zeo-only.cfg          # Solo servidor ZEO (producciÃ³n)
â”œâ”€â”€ config/               # Plantillas de configuraciÃ³n
â”‚   â””â”€â”€ templates/        # Plantillas para deployment
â”œâ”€â”€ deploy/               # Configuraciones de deployment
â”œâ”€â”€ var/                  # Datos de la aplicaciÃ³n
â”‚   â”œâ”€â”€ blobstorage/      # Almacenamiento de blobs
â”‚   â”œâ”€â”€ filestorage/      # Base de datos ZODB
â”‚   â””â”€â”€ log/              # Logs de la aplicaciÃ³n
â””â”€â”€ src/                  # Paquetes en desarrollo
    â”œâ”€â”€ genweb.organs/
    â”œâ”€â”€ genweb6.core/
    â”œâ”€â”€ genweb6.theme/
    â”œâ”€â”€ genweb6.upc/
    â”œâ”€â”€ contentimport/
    â”œâ”€â”€ collective.exportimport/
    â”œâ”€â”€ collective.recipe.filestorage/
    â””â”€â”€ ftw.casauth/
```

## ðŸ—ï¸ Plantillas de ConfiguraciÃ³n

El proyecto usa un sistema de plantillas para diferentes entornos:

### Configuraciones Principales
- **Local/Desarrollo**: `organs.cfg` - ConfiguraciÃ³n completa para desarrollo
- **Zope Only**: `zope-only.cfg` - Solo instancias Zope (producciÃ³n)
- **ZEO Only**: `zeo-only.cfg` - Solo servidor ZEO (producciÃ³n)

### Plantillas de Bootstrap
- `bootstrap.sh.in` - Plantilla para local/desarrollo
- `bootstrap.sh.zope-only.in` - Plantilla para Zope only
- `bootstrap.sh.zeo-only.in` - Plantilla para ZEO only

### Plantillas de CustomizaciÃ³n
- `customizeme.cfg.in` - ConfiguraciÃ³n local
- `customizeme.zope-only.cfg.in` - ConfiguraciÃ³n Zope
- `customizeme.zeo-only.cfg.in` - ConfiguraciÃ³n ZEO

### Plantillas de Deployment
- `balancer*.conf.template` - ConfiguraciÃ³n de balanceadores
- `cache*.conf.template` - ConfiguraciÃ³n de cachÃ©
- `circus_*.ini.template` - ConfiguraciÃ³n de Circus (supervisor)
- `purge_varnish.*.template` - Scripts de purge de Varnish

## ðŸš€ Proceso de Setup

1. **Crear entorno virtual**: `python3.11 -m venv /path/to/venv`
2. **Clonar repositorio**: `git clone https://github.com/UPCnet/genweb6.buildout`
3. **Copiar plantillas**:
   ```bash
   cp customizeme.cfg.in customizeme.cfg
   cp bootstrap.sh.in bootstrap.sh
   ```
4. **Configurar parÃ¡metros** en `customizeme.cfg`
5. **Ejecutar bootstrap**: `./bootstrap.sh [python_path]`
   - El bootstrap automÃ¡ticamente ejecuta `pip install -r requirements.txt`
   - Ejecuta `buildout -N -c organs.cfg` (dos veces para asegurar configuraciÃ³n completa)
6. **Iniciar instancia**: `./bin/instance fg` o `./bin/instance start`

## ðŸ“‹ Requisitos del Entorno

- **Python 3.11.1** - VersiÃ³n especÃ­fica requerida
- **Entorno virtual** - Aislado para el proyecto
- **Ruta del venv** - Configurable en bootstrap.sh o como argumento

## ðŸ­ Configuraciones de ProducciÃ³n

### Zope Only (zope-only.cfg)
- MÃºltiples instancias Zope (zc1, zc2, zc3, zc4, zcdebug)
- ConfiguraciÃ³n de filestorage distribuido
- Supervisor para gestiÃ³n de procesos
- Backup automÃ¡tico
- Purge de Varnish

### ZEO Only (zeo-only.cfg)
- Servidores ZEO (zeo1, zeo2)
- Filestorage distribuido
- Backup de ZEO
- Supervisor para gestiÃ³n

## ðŸ’» Desarrollo

- `mr.developer` para gestiÃ³n de repositorios
- `always-checkout = false`
- `auto-checkout` basado en developeggs
- Bootstrap con Python 3.11.1
- ConfiguraciÃ³n de entorno virtual personalizada

## ðŸ“‹ ConfiguraciÃ³n de Proyectos

### projects.cfg
```ini
[genwebcore]
eggs = genweb6.core
       genweb6.theme
       collective.recipe.filestorage
       ftw.casauth

[genwebupc]
eggs = genweb6.upc

[genwebaddons]
eggs = genweb.organs

[genwebmigration]
eggs = collective.exportimport
       contentimport
```

### Dependencias EspecÃ­ficas
- **genweb6.core**: Core de Genweb 6
- **genweb6.theme**: Tema de Genweb 6
- **genweb6.upc**: Paquete especÃ­fico UPC
- **genweb.organs**: Funcionalidad de Ã³rganos
- **collective.exportimport**: MigraciÃ³n de contenido
- **contentimport**: ImportaciÃ³n de contenido
- **ftw.casauth**: AutenticaciÃ³n CAS
- **collective.recipe.filestorage**: Filestorage distribuido

## âš™ï¸ ConfiguraciÃ³n Principal

### buildout.cfg
```ini
[buildout]
extends =
    versions.cfg
    sources.cfg
    projects.cfg
    customizeme.cfg

parts =
    instance
    zopepy
    test
    i18ndude
    update_locale

eggs =
    Plone
    genweb.organs
    genweb6.core
    genweb6.theme
    contentimport
    collective.exportimport
```

### versions.cfg
```ini
# Plone 6
Plone = 6.0.11
plone.app.contenttypes = 3.0.2
plone.app.dexterity = 3.0.2

# MigraciÃ³n
collective.exportimport = 1.8
contentimport = 1.0

# Genweb
genweb.organs = 1.0
genweb6.core = 1.0
genweb6.theme = 1.0
```

## ðŸš€ Comandos Ãštiles

### Desarrollo
```bash
# Iniciar instancia (foreground)
./bin/instance fg

# Iniciar instancia (background)
./bin/instance start

# Shell interactivo
./bin/zopepy

# Tests
./bin/test

# Actualizar locales
./bin/update_locale
```

### MigraciÃ³n

1. **Exportar desde Plone 4**: Acceder a `http://plone4-site/@@export_content`
2. **Importar en Plone 6**: Acceder a `http://plone6-site/@@import_content`


## ðŸ“ Paquetes en Desarrollo

### sources.cfg
```ini
[sources]
# genwebcore
genweb6.core = git https://github.com/UPCnet/genweb6.core.git branch=master
genweb6.theme = git https://github.com/UPCnet/genweb6.theme.git branch=master
collective.recipe.filestorage = git https://github.com/UPCnet/collective.recipe.filestorage.git branch=main
ftw.casauth = git https://github.com/UPCnet/ftw.casauth.git branch=master

# genwebupc
genweb6.upc = git https://github.com/UPCnet/genweb6.upc.git branch=master

# genwebaddons
genweb.organs = git https://github.com/UPCnet/genweb.organs.git branch=pyto3

# genwebmigration
collective.exportimport = git https://github.com/collective/collective.exportimport.git branch=main
contentimport = git https://github.com/UPCnet/contentimport.git branch=main
```

### develop-eggs
```ini
# Paquetes en desarrollo local
genweb.organs = src/genweb.organs
genweb6.core = src/genweb6.core
genweb6.theme = src/genweb6.theme
contentimport = src/contentimport
```

## ðŸ”§ ConfiguraciÃ³n de Instancia

### instance.cfg
```ini
[instance]
recipe = plone.recipe.zope2instance
http-address = 11001
user = admin:admin
blob-storage = var/blobstorage
effective-user = plone
profile = on
http-fast-listen = off
asyncore-use-poll = on
eggs =
  Plone
  Pillow
  ${buildout:eggs}
  ${buildout:developeggs}

environment-vars =
  PTS_LANGUAGES ca es en
  zope_i18n_allowed_languages ca es en
  zope_i18n_compile_mo_files true
  ldapbindpasswd ${ldapconfig:bindpasswd}
  PYTHONWARNINGS ignore
  varnish_url ${deployment:varnish_url}
  varnish_to_ban ${deployment:varnish_to_ban}
  dorsal ${deployment:dorsal}
  home_user ${custom:home_user}
  home_pass ${custom:home_pass}
  home_url ${custom:home_url}
```

### ZCML
```ini
# ConfiguraciÃ³n ZCML
zcml =
```

### Filestorage Distribuido
```ini
[filestorage]
# Para habilitar ZODB mount points en el buildout de desarrollo
# para propÃ³sitos de testing y debug
recipe = collective.recipe.filestorage
parts = ${custom:parts}
parts = 996 997 998 999

location = var/filestorage/Data_%(fs_part_name)s.fs
blob-storage = var/blobstorage/%(fs_part_name)s
```

### Site Packages
```ini
[site-packages]
# Reproduce un Ã¡rbol de directorios Ãºnico de los paquetes Python instalados
# Ãštil para buscar, navegar o explorar todo el cÃ³digo fuente de la aplicaciÃ³n
recipe = collective.recipe.omelette
eggs = ${instance:eggs}
```

## ðŸ§ª Testing

### test.cfg
```ini
[test]
recipe = zc.recipe.testrunner
defaults = ['--auto-color', '--auto-progress']
eggs = ${buildout:eggs}
```

### Comandos de Test
```bash
# Tests unitarios
bin/test -s genweb.organs

# Tests con coverage
bin/test --coverage

# Tests especÃ­ficos
bin/test -t test_specific
```

## ðŸŒ InternacionalizaciÃ³n

### i18ndude.cfg
```ini
[i18ndude]
recipe = i18ndude
```

### Comandos i18n
```bash
# Extraer strings
bin/i18ndude rebuild-pot

# Actualizar traducciones
bin/update_locale

# Compilar traducciones
bin/i18ndude compile
```

## ðŸ“¦ Dependencias

### requirements.txt
```
# Plone 6
Plone==6.0.11
plone.app.contenttypes==3.0.2
plone.app.dexterity==3.0.2

# MigraciÃ³n
collective.exportimport==1.8

# Desarrollo
ipdb==0.13.13
pytest==7.4.3
```

### setup.py (paquetes)
```python
install_requires=[
    'setuptools',
    'Plone>=6.0',
    'plone.app.dexterity',
    'plone.app.contenttypes',
    'collective.exportimport',
],
```

## ðŸš¨ Troubleshooting

### Errores Comunes

#### ImportError
```bash
# Limpiar buildout
rm -rf parts/ eggs/ develop-eggs/
./bootstrap.sh
```

#### ZCML Errors
```bash
# Verificar configuraciÃ³n ZCML
bin/instance debug

# Revisar logs
tail -f var/log/instance.log
```

#### Memory Issues
```bash
# Aumentar memoria
export ZOPE_OPTIONS="-Xmx2g"

# O en buildout.cfg
[instance]
environment-vars =
    ZOPE_OPTIONS -Xmx2g
```

## ðŸ“‹ Checklist de ConfiguraciÃ³n

- [ ] Versiones fijas en `versions.cfg`
- [ ] Paquetes en desarrollo en `sources.cfg`
- [ ] ZCML configurado correctamente
- [ ] Tests funcionando
- [ ] i18n configurado
- [ ] Logs sin errores
- [ ] MigraciÃ³n funcionando