---
globs: src/genweb.organs/**/*
description: Reglas especÃ­ficas para el paquete genweb.organs
---

# ğŸ›ï¸ Genweb.organs - Reglas EspecÃ­ficas

## ğŸ“ Estructura del Paquete

```
src/genweb.organs/
â”œâ”€â”€ src/genweb/organs/
â”‚   â”œâ”€â”€ content/           # Tipos de contenido
â”‚   â”‚   â”œâ”€â”€ acta/         # Actas de sesiones
â”‚   â”‚   â”œâ”€â”€ acord/        # Acuerdos
â”‚   â”‚   â”œâ”€â”€ organ/        # Ã“rganos
â”‚   â”‚   â”œâ”€â”€ punt/         # Puntos de agenda
â”‚   â”‚   â”œâ”€â”€ sessio/       # Sesiones
â”‚   â”‚   â””â”€â”€ subpunt/      # Subpuntos
â”‚   â”œâ”€â”€ browser/          # Vistas y templates
â”‚   â”œâ”€â”€ hooks.py          # Eventos y workflows
â”‚   â””â”€â”€ utils.py          # Utilidades
```

## ğŸ—‚ï¸ Tipos de Contenido

### Sessio (SesiÃ³n)
- **Campos clave**: `infoQuorums`, `horaInici`, `horaFi`
- **Validaciones**: Campos requeridos, fechas vÃ¡lidas
- **MÃ©todos**: `checkHasQuorum()`, `showOpenQuorum()`

### Acta
- **DefaultFactory**: Leer del contexto padre para evitar recursiÃ³n
- **Campos**: `membres_convidats`, `membres_convocats`, `hora_inici`, `hora_fi`
- **Dependencias**: IEventAccessor del contexto padre

### Punt/Subpunt/Acord
- **Campo crÃ­tico**: `estatsLlista` (schema.Choice con vocabulario)
- **Vocabulario**: `llistaEstats` parsea HTML del Ã³rgano
- **Valores**: Estados con/sin sufijos de color

## ğŸ”§ Patrones de CÃ³digo

### DefaultFactory Seguro
```python
def campo_default_factory(context):
    """Evitar recursiÃ³n leyendo del contexto padre."""
    try:
        parent = context.aq_parent
        if hasattr(parent, 'campo'):
            return parent.campo
    except (AttributeError, TypeError):
        pass
    return RichTextValue('')  # Valor por defecto seguro
```

### Vocabularios DinÃ¡micos
```python
def llistaEstats(context):
    """Generar vocabulario desde HTML del Ã³rgano."""
    organ = context.aq_parent
    if not hasattr(organ, 'estatsLlista'):
        return SimpleVocabulary([])

    html = organ.estatsLlista.raw
    # Parsear HTML y extraer estados
    # Manejar sufijos de color
    return SimpleVocabulary([SimpleTerm(value, value, value)])
```

### Manejo de Fechas
```python
def hora_default_factory(context):
    """Obtener hora del contexto padre si es evento."""
    try:
        parent = context.aq_parent
        event = IEventAccessor(parent)
        return event.start
    except TypeError:
        return None
```

## ğŸ¯ Validaciones EspecÃ­ficas

### infoQuorums
- **Tipo**: Dict con claves enteras
- **Acceso**: `infoQuorums[1]['end']` (clave entera)
- **MigraciÃ³n**: Mantener claves como enteros

### estatsLlista
- **Tipo**: Choice con vocabulario restringido
- **Valores**: Estados vÃ¡lidos del Ã³rgano
- **MigraciÃ³n**: Mapear valores legacy a vocabulario actual

### Campos RichText
- **Acceso**: `.output` para renderizado
- **ComparaciÃ³n**: Usar `hasattr(obj, 'output')`
- **Default**: `RichTextValue('')` para valores vacÃ­os

## ğŸ§ª Testing

### Tests Unitarios
```python
def test_default_factory_no_recursion(self):
    """Verificar que defaultFactory no cause recursiÃ³n."""
    acta = create_content('genweb.organs.acta')
    # Verificar que no falla al acceder al campo
    self.assertIsNotNone(acta.membres_convidats)
```

### Tests de MigraciÃ³n
```python
def test_infoQuorums_migration(self):
    """Verificar migraciÃ³n de infoQuorums."""
    # Simular datos de Plone 4
    # Verificar que se normalizan correctamente
```

## ğŸš¨ Errores Comunes

### RecursiÃ³n en DefaultFactory
- **SÃ­ntoma**: `RecursionError: maximum recursion depth exceeded`
- **Causa**: DefaultFactory accede al mismo campo
- **SoluciÃ³n**: Leer del contexto padre

### TypeError en RichTextValue
- **SÃ­ntoma**: `unhashable type: 'RichTextValue'`
- **Causa**: Acceso directo sin `.output`
- **SoluciÃ³n**: Verificar `hasattr(obj, 'output')`

### ValidationError en estatsLlista
- **SÃ­ntoma**: `Constraint not satisfied`
- **Causa**: Valor no estÃ¡ en vocabulario
- **SoluciÃ³n**: Revisar funciÃ³n `llistaEstats`

## ğŸ“ Convenciones

### Naming
- **Tipos**: `genweb.organs.tipo`
- **Interfaces**: `ITipo`
- **Vistas**: `TipoView`
- **Templates**: `tipo.pt`

### Imports
```python
from genweb.organs.content.sessio import ISessio
from genweb.organs.content.acta import IActa
from genweb.organs.content.punt import IPunt
```

### Docstrings
```python
def metodo(self, param):
    """DescripciÃ³n del mÃ©todo.

    Args:
        param: DescripciÃ³n del parÃ¡metro

    Returns:
        DescripciÃ³n del retorno

    Raises:
        ValidationError: Cuando el parÃ¡metro es invÃ¡lido
    """
```